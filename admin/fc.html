<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Add Flashcards</title>
    <style>
        /* Shared Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background-color: #fff;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        h1, h2, h3 {
            color: #1c1e21;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff; /* Ensure select has a background */
        }
        select:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        .hidden { display: none; }
        ol { list-style-type: decimal; padding-left: 20px; }
        li { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Panel</h1>
        
        <form id="adminForm">
            <!-- Step 1: Select Class and Subject -->
            <label for="classSelect">Class</label>
            <select id="classSelect" required>
                <option value="">-- Select a Class --</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11 JEE">11 JEE</option>
                <option value="11 NEET">11 NEET</option>
                <option value="12 JEE">12 JEE</option>
                <option value="12 NEET">12 NEET</option>
            </select>
            
            <label for="subjectSelect">Subject</label>
            <select id="subjectSelect" required disabled>
                <option value="">-- Select a Class First --</option>
            </select>

            <!-- Step 2: Choose Chapter -->
            <div>
                <input type="radio" id="newChapterRadio" name="chapterChoice" value="new" checked>
                <label for="newChapterRadio" style="display:inline;">Create New Chapter</label>
                <input type="radio" id="existingChapterRadio" name="chapterChoice" value="existing" style="margin-left: 20px;">
                <label for="existingChapterRadio" style="display:inline;">Add to Existing Chapter</label>
            </div>

            <div id="newChapterContainer">
                <label for="newChapterInput">New Chapter Name</label>
                <textarea id="newChapterInput" rows="1"></textarea>
            </div>

            <div id="existingChapterContainer" class="hidden">
                <label for="existingChapterSelect">Select Existing Chapter</label>
                <select id="existingChapterSelect"></select>
            </div>

            <!-- Step 3: Add Flashcards -->
            <hr style="margin: 20px 0;">
            <h2>Add Cards</h2>
            <div id="card-adder">
                <label for="question">Question</label>
                <textarea id="question" rows="3"></textarea>
                <label for="answer">Answer</label>
                <textarea id="answer" rows="3"></textarea>
                <button type="button" id="addCardBtn">Add Card to List</button>
            </div>

            <h3>Cards to be Added:</h3>
            <ol id="card-list"></ol>
            
            <button type="submit" id="saveBtn">Save to Firebase</button>
        </form>
        <p id="status"></p>
    </div>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4Fc3IhMFVz4v6mKc4tcc_yjaEIw4fbo4",
            authDomain: "xperts-flashcards.firebaseapp.com",
            projectId: "xperts-flashcards",
            storageBucket: "xperts-flashcards.appspot.com",
            messagingSenderId: "398115589486",
            appId: "1:398115589486:web:3c513f5624686edd36c57f",
            measurementId: "G-RYEDY563LR"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Start of Application Logic ---
        const classSelect = document.getElementById('classSelect');
        const subjectSelect = document.getElementById('subjectSelect');
        
        const subjectMap = {
            '6-10': ['ENGLISH', 'PHY', 'CHEM', 'MATH', 'BIO', 'SST'],
            'JEE': ['PHY', 'CHEM', 'MATH'],
            'NEET': ['PHY', 'CHEM', 'ZOOLOGY', 'BOTANY']
        };

        classSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            subjectSelect.innerHTML = '<option value="">-- Select a Subject --</option>';
            subjectSelect.disabled = true;

            let subjectList = [];
            if (['6', '7', '8', '9', '10'].includes(selectedClass)) {
                subjectList = subjectMap['6-10'];
            } else if (selectedClass.includes('JEE')) {
                subjectList = subjectMap['JEE'];
            } else if (selectedClass.includes('NEET')) {
                subjectList = subjectMap['NEET'];
            }

            if (subjectList.length > 0) {
                subjectList.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                });
                subjectSelect.disabled = false;
            }
            loadExistingChapters(); // Reload chapters when class changes
        });
        
        subjectSelect.addEventListener('change', loadExistingChapters);

        // --- Rest of the logic remains similar, but uses the new select elements ---
        const newChapterRadio = document.getElementById('newChapterRadio');
        const existingChapterRadio = document.getElementById('existingChapterRadio');
        const newChapterContainer = document.getElementById('newChapterContainer');
        const existingChapterContainer = document.getElementById('existingChapterContainer');
        const existingChapterSelect = document.getElementById('existingChapterSelect');
        const addCardBtn = document.getElementById('addCardBtn');
        const adminForm = document.getElementById('adminForm');
        const statusEl = document.getElementById('status');
        
        let cardsToAdd = [];

        newChapterRadio.addEventListener('change', () => {
            newChapterContainer.classList.remove('hidden');
            existingChapterContainer.classList.add('hidden');
        });
        existingChapterRadio.addEventListener('change', () => {
            newChapterContainer.classList.add('hidden');
            existingChapterContainer.classList.remove('hidden');
            loadExistingChapters();
        });

        async function loadExistingChapters() {
            const className = classSelect.value;
            const subjectName = subjectSelect.value;
            if (!className || !subjectName) {
                existingChapterSelect.innerHTML = '';
                return;
            };

            existingChapterSelect.innerHTML = '<option>Loading...</option>';
            const q = query(collection(db, "chapters"), where("class", "==", className), where("subject", "==", subjectName));
            
            try {
                const querySnapshot = await getDocs(q);
                existingChapterSelect.innerHTML = '';
                if (querySnapshot.empty) {
                    existingChapterSelect.innerHTML = '<option>No chapters found</option>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = doc.data().chapterName;
                        existingChapterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error loading chapters: ", error);
                statusEl.textContent = "Error loading chapters. Check console.";
            }
        }

        addCardBtn.addEventListener('click', () => {
            const question = document.getElementById('question').value.trim();
            const answer = document.getElementById('answer').value.trim();

            if (question && answer) {
                cardsToAdd.push({ question, answer });
                updateCardListView();
                document.getElementById('question').value = '';
                document.getElementById('answer').value = '';
            } else {
                alert('Please fill in both question and answer.');
            }
        });

        function updateCardListView() {
            const cardList = document.getElementById('card-list');
            cardList.innerHTML = '';
            cardsToAdd.forEach((card, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. Q: ${card.question.substring(0, 50)}...`;
                cardList.appendChild(li);
            });
        }
        
        adminForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            statusEl.textContent = 'Saving...';
            
            const className = classSelect.value;
            const subjectName = subjectSelect.value;

            if (!className || !subjectName) {
                alert('Please select a class and subject.');
                statusEl.textContent = '';
                return;
            }

            if (cardsToAdd.length === 0) {
                alert('Please add at least one card.');
                statusEl.textContent = '';
                return;
            }

            try {
                if (newChapterRadio.checked) {
                    const chapterName = document.getElementById('newChapterInput').value.trim();
                    if (!chapterName) {
                        alert('Please provide a new chapter name.');
                        statusEl.textContent = '';
                        return;
                    }
                    await addDoc(collection(db, "chapters"), {
                        class: className,
                        subject: subjectName,
                        chapterName: chapterName,
                        cards: cardsToAdd
                    });
                    statusEl.textContent = 'Successfully created new chapter and added cards!';
                } else {
                    const chapterId = existingChapterSelect.value;
                    if (!chapterId || existingChapterSelect.firstElementChild.textContent.includes('No chapters')) {
                        alert('Please select a valid existing chapter.');
                        statusEl.textContent = '';
                        return;
                    }
                    const chapterRef = doc(db, "chapters", chapterId);
                    await updateDoc(chapterRef, {
                        cards: arrayUnion(...cardsToAdd)
                    });
                    statusEl.textContent = `Successfully added ${cardsToAdd.length} cards to the chapter!`;
                }

                cardsToAdd = [];
                updateCardListView();
                adminForm.reset();
                subjectSelect.innerHTML = '<option value="">-- Select a Class First --</option>';
                subjectSelect.disabled = true;
                newChapterContainer.classList.remove('hidden');
                existingChapterContainer.classList.add('hidden');
                setTimeout(() => statusEl.textContent = '', 5000);

            } catch (error) {
                console.error("Error saving to Firebase: ", error);
                statusEl.textContent = 'Error saving. Please check the console.';
            }
        });
    </script>
</body>
</html>
