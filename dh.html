<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        :root{--primary-blue:#0066ff;--background-color:#f0f4f9}body{background-color:var(--background-color);margin:0;display:flex;height:100vh;justify-content:center;align-items:center}.spinner{width:50px;height:50px;border:5px solid rgba(0,102,255,.2);border-top-color:var(--primary-blue);border-radius:50%;animation:spin 1s ease-in-out infinite}@keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="spinner"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig={apiKey:"AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk",authDomain:"xperts-data.firebaseapp.com",projectId:"xperts-data",storageBucket:"xperts-data.firebasestorage.app",messagingSenderId:"934675149024",appId:"1:934675149024:web:23486a5f38f65f103ce085"};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const classUrlMap = {
            '6': 'https://abc.xyz/6', '7': 'https://abc.xyz/7', '8': 'https://abc.xyz/8',
            '9': 'https://abc.xyz/9', '10': 'https://abc.xyz/10',
            // Correct, normalized keys
            '11-NEET': 'https://abc.xyz/N11', '11-JEE': 'https://abc.xyz/J11',
            '12-NEET': 'https://abc.xyz/N12', '12-JEE': 'https://abc.xyz/J12',
            // Fallback for old, un-migrated data
            '11 NEET': 'https://abc.xyz/N11', '11 JEE': 'https://abc.xyz/J11',
            '12 NEET': 'https://abc.xyz/N12', '12 JEE': 'https://abc.xyz/J12'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const userId = localStorage.getItem('loggedInUserId');
            if (!userId) {
                return window.location.replace('1.html');
            }
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) throw new Error("User not found in database.");

                const userData = userDoc.data();
                const { class: userClass, goal: userGoal, role: userRole } = userData;

                if (userRole !== 'Student') return window.location.replace('4.html'); // Send non-students to their profile
                if (!userClass) throw new Error("Profile incomplete: class field is missing.");
                
                // --- THIS IS THE FIX ---
                let lookupKey = '';

                // First, check for the old, combined format (e.g., class: "12 NEET")
                if (typeof userClass === 'string' && userClass.includes(' ')) {
                    lookupKey = userClass;
                } 
                // Next, check for the new, correct format (e.g., class: "12", goal: "NEET")
                else if (userGoal === 'NEET' || userGoal === 'JEE') {
                    const normalizedClass = userClass.toString().replace('th', '');
                    lookupKey = `${normalizedClass}-${userGoal}`; // Creates "12-NEET"
                }
                // Finally, handle simple classes (e.g., class: "6")
                else {
                    lookupKey = userClass.toString().replace('th', '');
                }
                // --- END OF FIX ---

                const redirectUrl = classUrlMap[lookupKey];
                if (!redirectUrl) throw new Error(`Configuration Error: No URL found for key "${lookupKey}".`);

                window.location.replace(redirectUrl);

            } catch (error) {
                console.error("Redirect failed:", error);
                alert("Could not automatically redirect you. " + error.message + "\nTaking you to your profile page.");
                window.location.replace('4.html'); // Failsafe redirect to profile
            }
        });
    </script>
</body>
</html>
