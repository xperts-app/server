<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Xperts</title>
    <style>
        :root {
            --primary-color: #4a69bd;
            --secondary-color: #6a89cc;
            --background-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --text-light-color: #555;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --success-color: #27ae60;
            --danger-color: #e74c3c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-image: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--background-color);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .hidden { display: none !important; }

        /* --- Login Section --- */
        #login-section { max-width: 400px; margin: auto; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { color: var(--primary-color); margin: 0; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light-color); }
        input[type="text"], input[type="password"] {
            width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.2);
        }

        button {
            background-image: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white; padding: 14px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 600; width: 100%; transition: all 0.3s; background-size: 200%;
        }
        button:hover:not(:disabled) { background-position: right; box-shadow: 0 5px 15px rgba(74, 105, 189, 0.4); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        #error-message { color: var(--danger-color); text-align: center; font-weight: 500; min-height: 1.2em; margin-top: 15px; }

        /* --- Dashboard Section --- */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; }
        #welcome-message { margin: 0; color: var(--primary-color); font-size: 28px; }
        #logout-btn { background: var(--danger-color); width: auto; padding: 10px 20px; }
        #logout-btn:hover { background: #c0392b; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: var(--card-bg-color); padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px var(--shadow-color); text-align: center; }
        .card-value { font-size: 36px; font-weight: 700; color: var(--primary-color); }
        .card-label { font-size: 14px; color: var(--text-light-color); margin-top: 5px; }
        .results-section h2 { margin-bottom: 20px; color: #2c3e50; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        #results-table { width: 100%; border-collapse: collapse; }
        #results-table th, #results-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        #results-table thead th { background-color: #f9fafb; font-weight: 600; color: #333; }
        #results-table tbody tr:hover { background-color: #f9fafb; }

        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 50px; background: #f9fafb; border-radius: 8px; color: var(--text-light-color); }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-section">
            <div class="login-header"> <h1>Student Portal</h1> <p>Login to view your performance</p> </div>
            <form id="login-form">
                <div class="form-group"> <label for="mobile">Mobile Number</label> <input type="text" id="mobile" required> </div>
                <div class="form-group"> <label for="password">Password</label> <input type="password" id="password" required> </div>
                <button type="submit" id="login-btn">Login</button> <p id="error-message"></p>
            </form>
        </div>
        <div id="dashboard-section" class="hidden">
            <div class="dashboard-header"> <h1 id="welcome-message"></h1> <button id="logout-btn">Logout</button> </div>
            <div class="summary-cards">
                <div class="summary-card"> <div class="card-value" id="total-tests">-</div> <div class="card-label">Total Tests Taken</div> </div>
                <div class="summary-card"> <div class="card-value" id="avg-score">-</div> <div class="card-label">Average Score</div> </div>
                <div class="summary-card"> <div class="card-value" id="highest-score">-</div> <div class="card-label">Highest Score</div> </div>
            </div>
            <div class="results-section"> <h2>Detailed Results</h2> <div id="results-container"></div> </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ##### THIS IS THE FIX #####
            // The Firebase configuration is now correctly placed here.
            const firebaseConfig = {
                apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk",
                authDomain: "xperts-data.firebaseapp.com",
                projectId: "xperts-data",
                storageBucket: "xperts-data.firebasestorage.app",
                messagingSenderId: "934675149024",
                appId: "1:934675149024:web:23486a5f38f65f103ce085",
                measurementId: "G-6TS06NTDZQ"
            };

            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            const loginSection = document.getElementById('login-section');
            const dashboardSection = document.getElementById('dashboard-section');
            const loginForm = document.getElementById('login-form');
            const loginBtn = document.getElementById('login-btn');
            const errorMessage = document.getElementById('error-message');
            const welcomeMessage = document.getElementById('welcome-message');
            const resultsContainer = document.getElementById('results-container');
            const logoutBtn = document.getElementById('logout-btn');

            const loggedInStudent = localStorage.getItem('studentData');
            if (loggedInStudent) {
                showDashboard(JSON.parse(loggedInStudent));
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorMessage.textContent = '';
                loginBtn.disabled = true;
                loginBtn.textContent = 'Verifying...';

                const mobile = document.getElementById('mobile').value;
                const password = document.getElementById('password').value;

                try {
                    const studentQuery = db.collection('users').where('mobileNumber', '==', mobile).where('password', '==', password);
                    const querySnapshot = await studentQuery.get();

                    if (querySnapshot.empty) {
                        errorMessage.textContent = 'Invalid mobile number or password.';
                    } else {
                        const studentData = querySnapshot.docs[0].data();
                        localStorage.setItem('studentData', JSON.stringify(studentData));
                        showDashboard(studentData);
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    errorMessage.textContent = 'Login failed. A database index is likely required. Check console.';
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login';
                }
            });

            function showDashboard(studentData) {
                loginSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                welcomeMessage.textContent = `Welcome, ${studentData.fullName.split(' ')[0]}!`;
                fetchAndDisplayResults(studentData);
            }

            async function fetchAndDisplayResults(studentData) {
                resultsContainer.innerHTML = '<div class="spinner"></div>';
                try {
                    const testsSnapshot = await db.collection('tests').where('class', '==', studentData.class).get();
                    if (testsSnapshot.empty) {
                        updateSummaryCards(0, 0, 0); // Correctly pass numbers
                        return resultsContainer.innerHTML = '<div class="empty-state">No tests have been assigned to your class yet.</div>';
                    }
                    
                    const resultPromises = testsSnapshot.docs.map(doc => 
                        db.collection('tests').doc(doc.id).collection('results').doc(studentData.mobileNumber).get());
                    
                    const resultDocs = await Promise.all(resultPromises);
                    const allResults = [];
                    resultDocs.forEach((resultDoc, index) => {
                        if (resultDoc.exists) {
                            allResults.push({ ...testsSnapshot.docs[index].data(), result: resultDoc.data() });
                        }
                    });

                    if (allResults.length === 0) {
                        updateSummaryCards(0, 0, 0); // Correctly pass numbers
                        return resultsContainer.innerHTML = '<div class="empty-state">Your marks have not been entered for any available tests.</div>';
                    }

                    const validMarks = allResults.map(r => r.result.marks).filter(m => m !== null && !isNaN(m));
                    const totalTests = validMarks.length;
                    const sumOfScores = validMarks.reduce((sum, mark) => sum + mark, 0);
                    const averageScore = totalTests > 0 ? (sumOfScores / totalTests) : 0;
                    const highestScore = totalTests > 0 ? Math.max(...validMarks) : 0;
                    
                    updateSummaryCards(totalTests, averageScore, highestScore);
                    
                    let tableHTML = `<table id="results-table"><thead><tr><th>Test Title</th><th>Subject</th><th>Your Score</th></tr></thead><tbody>`;
                    allResults.forEach(item => {
                        tableHTML += `<tr><td>${item.title}</td><td>${item.subject}</td><td><b>${item.result.marks !== null ? item.result.marks : 'N/A'}</b></td></tr>`;
                    });
                    resultsContainer.innerHTML = tableHTML + '</tbody></table>';

                } catch (error) {
                    console.error("Error fetching results:", error);
                    resultsContainer.innerHTML = '<div class="empty-state">Could not load your results. Please try again later.</div>';
                }
            }

            function updateSummaryCards(total, avg, high) {
                document.getElementById('total-tests').textContent = total;
                document.getElementById('avg-score').textContent = avg.toFixed(1);
                document.getElementById('highest-score').textContent = high;
            }
            
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('studentData');
                window.location.reload();
            });
        });
    </script>
</body>
</html>
