<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary-blue:#0066ff;--background-color:#f0f4f9;--text-dark:#1d2c3c;--text-light:#5a6b7d;--border-color:#dbe2ea;--success-green:#28a745;}
        body{font-family:'Poppins',sans-serif;background-color:var(--background-color);margin:0;padding-top:5vh}
        .main-container{max-width:600px;margin:auto;padding:20px;text-align:center}
        .illustration{width:150px;height:150px;margin:0 auto 20px auto}
        h2{font-weight:600;font-size:28px;color:var(--text-dark);margin-bottom:12px}
        p.subtitle{color:var(--text-light);font-size:16px;margin-bottom:30px}
        .selection-area{margin-bottom:30px;text-align:left}
        label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;color:var(--text-dark)}
        select{width:100%;padding:15px;border:1px solid var(--border-color);border-radius:12px;font-size:16px;background-color:#fff;font-family:'Poppins',sans-serif}
        
        #student-list-container{background-color:white;border-radius:16px;padding:10px 20px;text-align:left;box-shadow:0 8px 30px rgba(0,0,0,0.05);min-height:50px}
        .student-row{display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-bottom:1px solid #eef2f5}
        .student-row:last-child{border-bottom:none}
        .student-row span{font-weight:500;color:var(--text-dark)}
        .attendance-options label{display:inline-flex;align-items:center;margin-left:20px;font-size:15px;color:var(--text-light)}
        .attendance-options input{margin-right:8px;width:18px;height:18px;accent-color:var(--primary-blue)}
        .placeholder-text{padding:20px;color:var(--text-light);text-align:center}
        
        .btn-primary{background-color:var(--success-green);color:#fff;border:none;padding:16px 0;border-radius:12px;font-size:18px;font-weight:600;width:100%;cursor:pointer;transition:all .3s;margin-top:30px}
        .btn-primary:disabled{background-color:#a3d9b1;cursor:not-allowed}
        #message-area{text-align:center;font-weight:500;margin-top:20px;min-height:1.2em}
        #message-area.success{color:var(--success-green)}
        #message-area.error{color:#dc3545}
    </style>
</head>
<body>
    <div class="main-container">
        <!-- SVG Illustration -->
        <svg class="illustration" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 10L11 14L9 12" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>

        <h2>Mark Attendance</h2>
        <p class="subtitle">Select a class to view the student list and mark today's attendance.</p>
        
        <div class="selection-area">
            <label for="class-select">Select a Class</label>
            <select id="class-select">
                <option value="">-- Choose a class --</option>
                <option value="6">6th</option>
                <option value="7">7th</option>
                <option value="8">8th</option>
                <option value="9">9th</option>
                <option value="10">10th</option>
                <!-- FIX #1: The value is now just the class number -->
                <option value="11">11th NEET</option>
                <option value="11">11th JEE</option>
                <option value="12">12th NEET</option>
                <option value="12">12th JEE</option>
            </select>
        </div>

        <div id="student-list-container">
            <p class="placeholder-text">Students will appear here once a class is selected.</p>
        </div>

        <button class="btn-primary" id="save-attendance-btn" style="display: none;">Save Attendance</button>
        <p id="message-area"></p>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk", authDomain: "xperts-data.firebaseapp.com", projectId: "xperts-data", storageBucket: "xperts-data.firebasestorage.app", messagingSenderId: "934675149024", appId: "1:934675149024:web:23486a5f38f65f103ce085" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const classSelect = document.getElementById('class-select');
        const studentListContainer = document.getElementById('student-list-container');
        const saveBtn = document.getElementById('save-attendance-btn');

        classSelect.addEventListener('change', async (e) => {
            const selectedClass = e.target.value; // This will now be "6", "11", "12", etc.
            studentListContainer.innerHTML = '';
            saveBtn.style.display = 'none';
            
            if (!selectedClass) {
                studentListContainer.innerHTML = '<p class="placeholder-text">Students will appear here once a class is selected.</p>';
                return;
            }
            studentListContainer.innerHTML = '<p class="placeholder-text">Loading students...</p>';

            try {
                // FIX #2: The query is now simple and only uses the 'class' field.
                const query = db.collection('users')
                    .where('class', '==', selectedClass) // Looks for class: "11", "12", etc.
                    .where('role', '==', 'Student');
                
                const snapshot = await query.get();

                if (snapshot.empty) {
                    studentListContainer.innerHTML = '<p class="placeholder-text">No students found for this class. Please ensure student data is correct.</p>';
                    return;
                }

                studentListContainer.innerHTML = '';
                const students = [];
                snapshot.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
                students.sort((a,b) => a.fullName.localeCompare(b.fullName)); // Sort alphabetically

                students.forEach(student => {
                    const row = document.createElement('div');
                    row.className = 'student-row';
                    row.dataset.id = student.id;
                    row.dataset.name = student.fullName;
                    row.innerHTML = `
                        <span>${student.fullName}</span>
                        <div class="attendance-options">
                            <label><input type="radio" name="status-${student.id}" value="Present" required> Present</label>
                            <label><input type="radio" name="status-${student.id}" value="Absent"> Absent</label>
                        </div>`;
                    studentListContainer.appendChild(row);
                });
                saveBtn.style.display = 'block';

            } catch (error) { 
                console.error("Error fetching students:", error);
                studentListContainer.innerHTML = '<p class="placeholder-text" style="color: #dc3545;">An error occurred. A Firestore index on "class" and "role" might be required.</p>';
            }
        });
        
        // The save logic is already correct and does not need changes.
    </script>
</body>
</html>
