<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - Admin</title>
    <!-- Styles remain the same, so they are omitted for brevity -->
    <style>:root{/*...All your existing styles...*/}</style>
</head>
<body>
    <div class="main-container">
        <!-- All UI elements remain the same -->
        <svg class="illustration" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 10L11 14L9 12" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h2>Mark Attendance</h2>
        <p class="subtitle">Select a class to view the student list and mark today's attendance.</p>
        <div class="selection-area">
            <label for="class-select">Select a Class</label>
            <select id="class-select">
                <option value="">-- Choose a class --</option>
                <option value="6">6th</option><option value="7">7th</option><option value="8">8th</option>
                <option value="9">9th</option><option value="10">10th</option><option value="11">11th</option><option value="12">12th</option>
            </select>
        </div>
        <div id="student-list-container"><p class="placeholder-text">Students will appear here once a class is selected.</p></div>
        <button class="btn-primary" id="save-attendance-btn" style="display: none;">Save Attendance</button>
        <p id="message-area"></p>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk", authDomain: "xperts-data.firebaseapp.com", projectId: "xperts-data", storageBucket: "xperts-data.firebasestorage.app", messagingSenderId: "934675149024", appId: "1:934675149024:web:23486a5f38f65f103ce085" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const classSelect = document.getElementById('class-select');
        const studentListContainer = document.getElementById('student-list-container');
        const saveBtn = document.getElementById('save-attendance-btn');

        classSelect.addEventListener('change', async (e) => {
            const selectedClassStr = e.target.value;
            studentListContainer.innerHTML = '';
            saveBtn.style.display = 'none';
            
            if (!selectedClassStr) {
                studentListContainer.innerHTML = '<p class="placeholder-text">Students will appear here once a class is selected.</p>';
                return;
            }
            studentListContainer.innerHTML = '<p class="placeholder-text">Loading students...</p>';

            try {
                // --- THIS IS THE ROBUST FIX ---
                // We will now query for BOTH the string and number version of the class.
                const selectedClassNum = parseInt(selectedClassStr, 10);
                const usersRef = db.collection('users');

                const queryForString = usersRef.where('class', '==', selectedClassStr).where('role', '==', 'Student').get();
                const queryForNumber = usersRef.where('class', '==', selectedClassNum).where('role', '==', 'Student').get();

                // Run both queries at the same time
                const [stringResults, numberResults] = await Promise.all([queryForString, queryForNumber]);

                // Use a Map to combine results and automatically handle duplicates
                const studentsMap = new Map();
                stringResults.forEach(doc => studentsMap.set(doc.id, { id: doc.id, ...doc.data() }));
                numberResults.forEach(doc => studentsMap.set(doc.id, { id: doc.id, ...doc.data() }));

                const students = Array.from(studentsMap.values());
                // --- END OF FIX ---

                if (students.length === 0) {
                    studentListContainer.innerHTML = '<p class="placeholder-text">No students found for this class.</p>';
                    return;
                }
                
                studentListContainer.innerHTML = '';
                students.sort((a,b) => a.fullName.localeCompare(b.fullName));

                students.forEach(student => {
                    const row = document.createElement('div');
                    row.className = 'student-row';
                    row.dataset.id = student.id;
                    row.dataset.name = student.fullName;
                    row.innerHTML = `
                        <span>${student.fullName}</span>
                        <div class="attendance-options">
                            <label><input type="radio" name="status-${student.id}" value="Present" required> Present</label>
                            <label><input type="radio" name="status-${student.id}" value="Absent"> Absent</label>
                        </div>`;
                    studentListContainer.appendChild(row);
                });
                saveBtn.style.display = 'block';

            } catch (error) { 
                console.error("Error fetching students:", error);
                studentListContainer.innerHTML = '<p class="placeholder-text" style="color: #dc3545;">An error occurred. A Firestore index on "class" and "role" might be required.</p>';
            }
        });
        
    </script>
</body>
</html>
