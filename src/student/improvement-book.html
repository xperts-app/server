<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improvement Book</title>
    <style>
        :root {
            --primary-text: #1a1a1a; --secondary-text: #6c757d; --accent-color: #007bff;
            --bg-color: #f8f9fa; --card-bg: #ffffff; --border-color: #e9ecef;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--primary-text); margin: 0; }

        .page-container { display: flex; flex-direction: column; height: 100vh; max-width: 600px; margin: auto; background-color: var(--bg-color); }
        .header { background-color: var(--card-bg); padding: 15px 20px; display: flex; align-items: center; gap: 15px; }
        .back-arrow { font-size: 24px; cursor: pointer; text-decoration: none; color: var(--primary-text); }
        .header-text h1 { font-size: 22px; margin: 0; }
        .header-text p { font-size: 14px; margin: 2px 0 0; color: var(--secondary-text); }
        
        .subject-tabs { background-color: var(--card-bg); padding: 0 20px; display: flex; gap: 25px; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid var(--border-color); -ms-overflow-style: none; scrollbar-width: none; }
        .subject-tabs::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 15px 5px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 500; color: var(--secondary-text); border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary-text); border-bottom-color: var(--primary-text); }

        .main-content { flex-grow: 1; overflow-y: auto; padding: 25px 15px; }
        
        .module { background-color: var(--card-bg); border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .module summary { display: flex; align-items: center; padding: 20px; cursor: pointer; list-style: none; }
        .module summary::-webkit-details-marker { display: none; }
        .module-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; background-color: #e7f1ff; }
        .module-name { font-size: 18px; font-weight: 600; flex-grow: 1; }
        .expand-arrow { transition: transform 0.3s ease; }
        .module[open] > summary .expand-arrow { transform: rotate(180deg); }

        .module-actions { padding: 0 20px 20px 20px; }
        .action-card { background-color: #f8f9fa; border-radius: 12px; padding: 15px; }
        .mistake-progress p { margin: 0 0 10px 0; font-weight: 500; }
        .progress-track { width: 100%; height: 6px; background-color: #e9ecef; border-radius: 3px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; background-color: var(--accent-color); border-radius: 3px; transition: width 0.3s; }
        .action-buttons { display: flex; justify-content: space-between; align-items: center; }
        .btn-group { display: flex; gap: 10px; }
        .btn { padding: 8px 18px; font-size: 14px; font-weight: 600; border-radius: 20px; cursor: pointer; }
        .btn-outline { border: 1.5px solid var(--primary-text); background: none; color: var(--primary-text); }
        .btn-solid { border: none; background: var(--accent-color); color: white; }
        .btn-clear { background: none; border: none; cursor: pointer; padding: 5px; }

        .empty-state { text-align: center; padding: 50px 20px; color: var(--secondary-text); }
        .subject-content.hidden { display: none; }
    </style>
</head>
<body>
    <div class="page-container">
        <header class="header">
            <a href="#" class="back-arrow" onclick="history.back(); return false;">‚Üê</a>
            <div class="header-text">
                <h1>Improvement Book</h1>
                <p>Re-attempt your mistakes and improve</p>
            </div>
        </header>
        <nav class="subject-tabs" id="subjectTabs"></nav>
        <main class="main-content" id="mainContent"></main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const subjectTabsContainer = document.getElementById('subjectTabs');
            const mainContentContainer = document.getElementById('mainContent');

            let improvementBook = JSON.parse(localStorage.getItem('improvementBook')) || {};
            let improvementProgress = JSON.parse(localStorage.getItem('improvementProgress')) || {};
            let subjectData = {};

            const subjectIcons = {
                DEFAULT: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3L4 9L12 15L20 9L12 3Z" stroke="#4263eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 10.5L12 16L5 10.5" stroke="#4263eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 15L12 20L5 15" stroke="#4263eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                MISCELLANEOUS: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.364 5.63604C19.9261 7.19821 20.7071 8.8386 20.7071 11C20.7071 14.866 17.5731 18 13.7071 18C12.5458 18 11.454 17.7187 10.5 17.2281M5.63604 18.364C7.19821 19.9261 8.8386 20.7071 11 20.7071C14.866 20.7071 18 17.5731 18 13.7071C18 12.5458 17.7187 11.454 17.2281 10.5M10.5 6.77187C11.454 6.28126 12.5458 6 13.7071 6C17.5731 6 20.7071 9.13401 20.7071 13M6.77187 13.5C6.28126 12.546 6 11.4542 6 10.2929C6 6.4269 9.13401 3.29289 13 3.29289C14.1614 3.29289 15.2533 3.57415 16.2 4.06476M11.636 12.364L16 8L8 16" stroke="#4263eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            };

            function init() {
                processData();
                const subjects = Object.keys(subjectData);
                if (subjects.length === 0) {
                    showEmptyState();
                } else {
                    renderTabs(subjects);
                    renderAllContent();
                    setupEventListeners();
                    switchTab(subjects[0]);
                }
            }

            function processData() {
                subjectData = {};
                for (const className in improvementBook) {
                    for (const subjectName in improvementBook[className]) {
                        if (!subjectData[subjectName]) subjectData[subjectName] = {};
                        for (const chapterName in improvementBook[className][subjectName]) {
                            subjectData[subjectName][chapterName] = improvementBook[className][subjectName][chapterName];
                        }
                    }
                }
            }

            function renderTabs(subjects) {
                let tabsHTML = '';
                subjects.sort().forEach(subject => {
                    tabsHTML += `<button class="tab-btn" data-subject="${subject}">${subject}</button>`;
                });
                subjectTabsContainer.innerHTML = tabsHTML;
            }

            function renderAllContent() {
                let allHTML = '';
                for (const subject in subjectData) {
                    allHTML += `<div id="content-${subject}" class="subject-content hidden">${renderContentForSubject(subject)}</div>`;
                }
                mainContentContainer.innerHTML = allHTML;
            }

            function renderContentForSubject(subject) {
                const chapters = subjectData[subject];
                if (!chapters) return '';
                let subjectHTML = '';
                for (const chapter in chapters) {
                    const questions = chapters[chapter];
                    const totalMistakes = questions.length;
                    subjectHTML += `
                    <details class="module" data-subject="${subject}" data-chapter="${chapter}">
                        <summary>
                            <div class="module-icon">${subjectIcons[subject.toUpperCase()] || subjectIcons.DEFAULT}</div>
                            <span class="module-name">${chapter}</span>
                            <svg class="expand-arrow" width="24" height="24" viewBox="0 0 24 24"><path d="M6 9L12 15L18 9" stroke="#1a1a1a" stroke-width="2"/></svg>
                        </summary>
                        <div class="module-actions">
                            <div class="action-card">
                                <div class="mistake-progress">
                                    <p>${totalMistakes} Mistakes</p>
                                </div>
                                <div class="action-buttons">
                                    <div class="btn-group">
                                        <button class="btn btn-outline btn-review">Review</button>
                                        <button class="btn btn-solid btn-reattempt">Re-attempt</button>
                                    </div>
                                    <button class="btn-clear btn-mastered" title="Mark as Mastered">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </details>`;
                }
                return subjectHTML;
            }

            function setupEventListeners() {
                subjectTabsContainer.addEventListener('click', e => {
                    if (e.target.matches('.tab-btn')) switchTab(e.target.dataset.subject);
                });
                mainContentContainer.addEventListener('click', e => {
                    const moduleElement = e.target.closest('.module');
                    if (!moduleElement) return;
                    const subject = moduleElement.dataset.subject;
                    const chapter = moduleElement.dataset.chapter;
                    if (e.target.closest('.btn-review')) handleReview(subject, chapter);
                    if (e.target.closest('.btn-reattempt')) handleReattempt(subject, chapter);
                    if (e.target.closest('.btn-mastered')) handleClear(subject, chapter);
                });
            }

            function handleReview(subject, chapter) {
                const questions = subjectData[subject][chapter];
                sessionStorage.setItem('chapterReviewSession', JSON.stringify({ chapterName: chapter, questions: questions }));
                window.location.href = '9.html';
            }

            function handleReattempt(subject, chapter) {
                const questions = subjectData[subject][chapter];
                // Prepare the session with only the mistaken questions
                const testSessionData = { questions: questions };
                sessionStorage.setItem('testSession', JSON.stringify(testSessionData));
                // Redirect to 4.html with a special parameter to trigger re-attempt mode
                window.location.href = `4.html?source=improvement`;
            }

            function handleClear(subject, chapter) {
                if (!confirm(`Are you sure you want to remove all mistakes for "${chapter}"? This cannot be undone.`)) return;
                let classKey;
                for (const className in improvementBook) {
                    if (improvementBook[className][subject] && improvementBook[className][subject][chapter]) {
                        classKey = className;
                        break;
                    }
                }
                if (classKey) {
                    delete improvementBook[classKey][subject][chapter];
                    if (Object.keys(improvementBook[classKey][subject]).length === 0) delete improvementBook[classKey][subject];
                    if (Object.keys(improvementBook[classKey]).length === 0) delete improvementBook[classKey];
                    localStorage.setItem('improvementBook', JSON.stringify(improvementBook));
                    init(); // Re-render the entire view
                }
            }

            function switchTab(subject) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.subject === subject));
                document.querySelectorAll('.subject-content').forEach(content => content.classList.toggle('hidden', content.id !== `content-${subject}`));
            }

            function showEmptyState() {
                mainContentContainer.innerHTML = `<div class="empty-state"><h3>Your Improvement Book is Empty</h3><p>Keep practicing! Mistakes will show up here.</p></div>`;
            }
            init();
        });
    </script>
</body>
</html>
