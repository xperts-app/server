<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Chapters</title>
    <style>
        :root {
            --primary-text: #1a1a1a;
            --secondary-text: #6c757d;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-color: #e9ecef;
            --accent-color: #007bff;
            --disabled-color: #d1d5db;
            --selected-bg: #e7f1ff;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            font-size: 16px;
        }

        .page-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px; /* For better viewing on desktop */
            margin: auto;
            background-color: var(--card-bg);
        }

        /* --- Header --- */
        .header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }
        .back-arrow {
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-text);
            text-decoration: none;
        }
        .progress-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .progress-indicator {
            width: 120px;
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            position: relative;
        }
        .progress-indicator::before {
            content: '';
            position: absolute;
            height: 100%;
            width: 50%; /* Step 1 of 2 */
            background-color: var(--primary-text);
            border-radius: 2px;
        }
        .progress-step {
            font-size: 14px;
            color: var(--secondary-text);
        }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .title-bar h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }
        .search-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .search-input-wrapper {
            margin-bottom: 15px;
            display: none; /* Initially hidden */
        }
        #searchInput {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            outline: none;
        }
        #searchInput:focus {
            border-color: var(--accent-color);
        }

        /* --- Chapter List --- */
        #chapterList {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #chapterList li {
            padding: 20px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        #chapterList li:first-child {
            border-top: 1px solid var(--border-color);
        }
        #chapterList li.selected {
            background-color: var(--selected-bg);
            color: var(--accent-color);
            font-weight: 600;
        }
        
        /* --- Footer --- */
        .footer {
            padding: 20px;
            background-color: var(--card-bg);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }
        .next-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .next-btn:disabled {
            background-color: var(--disabled-color);
            color: var(--secondary-text);
            cursor: not-allowed;
        }
        .next-btn:not(:disabled) {
            background-color: var(--primary-text);
            color: white;
        }
        .next-btn:not(:disabled):hover {
            opacity: 0.85;
        }
        
        .loader, .message { text-align: center; font-size: 1.1em; color: var(--secondary-text); margin-top: 30px; }

    </style>
</head>
<body>

    <div class="page-container">
        <header class="header">
            <a href="#" class="back-arrow" onclick="history.back(); return false;">‚Üê</a>
            <div class="progress-bar">
                <div class="progress-indicator"></div>
                <span class="progress-step">1/2</span>
            </div>
        </header>

        <main class="main-content">
            <div class="title-bar">
                <h1>Select</h1>
                <div class="search-icon" id="searchIcon">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.5 17.5L13.875 13.875M15.8333 9.16667C15.8333 12.8486 12.8486 15.8333 9.16667 15.8333C5.48477 15.8333 2.5 12.8486 2.5 9.16667C2.5 5.48477 5.48477 2.5 9.16667 2.5C12.8486 2.5 15.8333 5.48477 15.8333 9.16667Z" stroke="#1A1A1A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
            
            <div class="search-input-wrapper" id="searchInputWrapper">
                <input type="text" id="searchInput" placeholder="Search for a chapter...">
            </div>

            <div id="loader" class="loader">Loading chapters...</div>
            <ul id="chapterList"></ul>
            <div id="message" class="message"></div>
        </main>

        <footer class="footer">
            <button class="next-btn" id="nextBtn" disabled>Next</button>
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyBrdCOyTrQ_uU4jID8hWzCQzaXilhAcGcs",
          authDomain: "custom-practices.firebaseapp.com",
          projectId: "custom-practices",
          storageBucket: "custom-practices.firebasestorage.app",
          messagingSenderId: "636700937539",
          appId: "1:636700937539:web:d6ec9d88453e15481d33f6",
          measurementId: "G-JL58DMTZ0W"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM ELEMENTS ---
        const loader = document.getElementById('loader');
        const chapterList = document.getElementById('chapterList');
        const messageDiv = document.getElementById('message');
        const nextBtn = document.getElementById('nextBtn');
        const searchIcon = document.getElementById('searchIcon');
        const searchInputWrapper = document.getElementById('searchInputWrapper');
        const searchInput = document.getElementById('searchInput');

        // --- STATE ---
        let selectedChapters = new Set();
        let currentClass, currentSubject;

        // --- MAIN LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentClass = urlParams.get('class');
            currentSubject = urlParams.get('subject');

            if (!currentClass || !currentSubject) {
                displayMessage("No class or subject specified. Please go back and select them. Example URL: 2.html?class=11%20JEE&subject=PHY");
                loader.style.display = 'none';
                return;
            }
            
            fetchAndDisplayChapters(currentClass, currentSubject);
            setupEventListeners();
        });

        function setupEventListeners() {
            // Chapter selection
            chapterList.addEventListener('click', (e) => {
                if (e.target && e.target.nodeName === 'LI') {
                    const chapterName = e.target.dataset.chapter;
                    e.target.classList.toggle('selected');
                    if (selectedChapters.has(chapterName)) {
                        selectedChapters.delete(chapterName);
                    } else {
                        selectedChapters.add(chapterName);
                    }
                    updateNextButtonState();
                }
            });

            // Search functionality
            searchIcon.addEventListener('click', () => {
                const isHidden = searchInputWrapper.style.display === 'none' || searchInputWrapper.style.display === '';
                searchInputWrapper.style.display = isHidden ? 'block' : 'none';
                if(isHidden) searchInput.focus();
            });

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const allChapters = chapterList.getElementsByTagName('li');
                for (let li of allChapters) {
                    const chapterText = li.textContent.toLowerCase();
                    if (chapterText.includes(searchTerm)) {
                        li.style.display = '';
                    } else {
                        li.style.display = 'none';
                    }
                }
            });

            // Next button navigation
            nextBtn.addEventListener('click', () => {
                if(selectedChapters.size > 0) {
                    const encodedClass = encodeURIComponent(currentClass);
                    const encodedSubject = encodeURIComponent(currentSubject);
                    // Join multiple chapters with a special character, then encode the whole string
                    const chaptersParam = Array.from(selectedChapters).join(','); 
                    const encodedChapters = encodeURIComponent(chaptersParam);
                    
                    window.location.href = `3.html?class=${encodedClass}&subject=${encodedSubject}&chapter=${encodedChapters}`;
                }
            });
        }
        
        async function fetchAndDisplayChapters(className, subjectName) {
            try {
                // Fetch from both dedicated 'chapters' collection and implicitly from 'questions'
                const chapterPromise = db.collection('chapters').where('class', '==', className).where('subject', '==', subjectName).get();
                const questionPromise = db.collection('questions').where('class', '==', className).where('subject', '==', subjectName).get();
                const [chapterSnapshot, questionSnapshot] = await Promise.all([chapterPromise, questionPromise]);
                
                const chapterSet = new Set();
                chapterSnapshot.forEach(doc => chapterSet.add(doc.data().name));
                questionSnapshot.forEach(doc => chapterSet.add(doc.data().chapter));

                loader.style.display = 'none';

                if (chapterSet.size === 0) {
                    displayMessage(`No chapters found for ${className} - ${subjectName}. The admin needs to add content for this category.`);
                    return;
                }

                const sortedChapters = [...chapterSet].sort();
                sortedChapters.forEach(chapter => {
                    const li = document.createElement('li');
                    li.textContent = chapter;
                    li.dataset.chapter = chapter; // Store original name for selection logic
                    chapterList.appendChild(li);
                });

            } catch (error) {
                console.error("Error fetching chapters: ", error);
                displayMessage("An error occurred while fetching chapters. Please try again later.");
                loader.style.display = 'none';
            }
        }
        
        function updateNextButtonState() {
            if (selectedChapters.size > 0) {
                nextBtn.disabled = false;
            } else {
                nextBtn.disabled = true;
            }
        }

        function displayMessage(msg) {
            messageDiv.textContent = msg;
        }

    </script>

</body>
</html>
