<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Viewer</title>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-color: #6d6d6d;
            --text-primary: #1a202c;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
            --body-bg: #f7fafc;
        }
        .theme-bio, .theme-botany, .theme-zoology { --accent-color: #10B981; }
        .theme-eng { --accent-color: #EF4444; }
        .theme-phy, .theme-physics { --accent-color: #3B82F6; }
        .theme-math { --accent-color: #0EA5E9; }
        .theme-chem, .theme-sst { --accent-color: #A855F7; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--body-bg); color: var(--text-primary); }
        .app-container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        .chapter-header {
            color: white; padding: 20px; padding-top: 50px;
            border-bottom: 4px solid var(--accent-color); border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative; overflow: hidden; display: flex; align-items: flex-start;
            min-height: 180px; background-size: cover; background-position: center;
        }
        .chapter-header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.2) 60%, transparent 100%);
            z-index: 1;
        }
        .header-content {
            position: relative; z-index: 2; width: 100%;
            display: flex; align-items: center; gap: 15px;
        }
        .back-arrow { font-size: 24px; color: white; text-decoration: none; align-self: flex-start; }
        .header-title { flex-grow: 1; }
        .header-title h1 { font-size: 28px; font-weight: 700; }
        .header-title .class-details { font-size: 16px; opacity: 0.9; }
        .content-body { padding: 20px; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .content-section h2 { font-size: 22px; margin-bottom: 5px; font-weight: 700; }
        .section-underline { height: 4px; width: 50px; background-color: #EAB308; border-radius: 2px; margin-bottom: 20px; }
        .content-list { list-style: none; }
        .content-item {
            display: flex; align-items: center; gap: 15px; padding: 10px 0;
            border-bottom: 1px solid var(--border-color); text-decoration: none; color: var(--text-primary);
        }
        .item-thumbnail {
            flex-shrink: 0; width: 120px; height: 70px; border-radius: 12px; background-color: #ccc;
            position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: white; font-weight: bold;
        }
        .thumbnail-img { width: 100%; height: 100%; object-fit: cover; }
        .thumbnail-icon { font-size: 28px; }
        .item-details { flex-grow: 1; }
        .item-title { font-weight: 500; line-height: 1.4; }
        .item-action { flex-shrink: 0; }
        .download-icon { font-size: 24px; color: var(--text-secondary); }
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--card-bg); border-radius: 999px; padding: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: flex; gap: 8px; z-index: 100;
        }
        .nav-btn {
            background: transparent; border: none; padding: 10px 24px; border-radius: 999px;
            font-size: 16px; font-weight: 600; cursor: pointer; color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .nav-btn.active { background-color: var(--text-primary); color: white; }
        #loader, #message { text-align: center; font-size: 1em; padding: 40px; color: var(--text-secondary); }
        .error-message { color: #c53030; background-color: #fed7d7; padding: 15px; border-radius: 5px; margin: 20px; }
    </style>
</head>
<body class="theme-default">

    <div class="app-container">
        <header class="chapter-header" id="chapter-header">
            <div class="header-content">
                <a href="javascript:history.back()" class="back-arrow">←</a>
                <div class="header-title">
                    <h1 id="chapter-title">Loading...</h1>
                    <p class="class-details" id="class-details"></p>
                </div>
            </div>
        </header>

        <main class="content-body">
            <div id="loader">Loading content...</div>
            <section id="videos-section" class="content-section">
                <h2>Concept Videos</h2><div class="section-underline"></div><ul class="content-list" id="video-list"></ul>
            </section>
            <section id="notes-section" class="content-section">
                <h2>Notes</h2><div class="section-underline"></div><ul class="content-list" id="pdf-list"></ul>
            </section>
        </main>
    </div>

    <nav class="bottom-nav">
        <button id="learn-btn" class="nav-btn active">Learn</button>
        <button id="notes-btn" class="nav-btn">Notes</button>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyALyD306KRV3o4BF6JddkvESPRroU7ljDE",
          authDomain: "study-books-45192.firebaseapp.com",
          projectId: "study-books-45192",
          storageBucket: "study-books-45192.firebasestorage.app",
          messagingSenderId: "339305499523",
          appId: "1:339305499523:web:c51eaccbdaebe1293004b6",
          measurementId: "G-MZWBP5RR9Z"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const themeMap = { 'BIO': 'theme-bio', 'BOTANY': 'theme-botany', 'ZOOLOGY': 'theme-zoology', 'ENG': 'theme-eng', 'PHY': 'theme-phy', 'PHYSICS': 'theme-physics', 'MATH': 'theme-math', 'CHEM': 'theme-chem', 'SST': 'theme-sst' };
        const fullNameMap = { 'BIO': 'Biology', 'BOTANY': 'Botany', 'ZOOLOGY': 'Zoology', 'ENG': 'English', 'PHY': 'Physics', 'PHYSICS': 'Physics', 'MATH': 'Mathematics', 'CHEM': 'Chemistry', 'SST': 'Social Science' };
        const imageUrlMap = {
            'BIO': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRCbI9u0vnAPreKu_czfW4IFbD4OzIDIe4WeUcDudx__tNt7-qVhEbMiXSf&s=10', 'BOTANY': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSSzfxKjJdl013x1O3Ox8HvMx0FwU7Ya_TowO322qKTUZRZMqfHg56MchPN&s=10',
            'ZOOLOGY': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSvG-iWy6UbJGNiEWcph8fK0xPawpdecXLTXzhTlAalanirs9LR0xRKenrV&s=10', 'ENG': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSoSu1f6dLV5meh_lKHOhg_VrfABZ4Pg6hxw8JsdA4JHeN-17-w3znwBi7z&s=10',
            'PHY': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS1z5kXMKG22tkvaFs1GoUr0F_jgV6vPSwy8462fkZ5Oq2WtLT1PwtPqdlg&s=10', 'PHYSICS': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS1z5kXMKG22tkvaFs1GoUr0F_jgV6vPSwy8462fkZ5Oq2WtLT1PwtPqdlg&s=10',
            'MATH': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS1z5kXMKG22tkvaFs1GoUr0F_jgV6vPSwy8462fkZ5Oq2WtLT1PwtPqdlg&s=10', 'CHEM': 'https://plus.unsplash.com/premium_photo-1681426678542-613c306013e1?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8Y2hlbWlzdHJ5fGVufDB8fDB8fHww',
            'SST': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS1z5kXMKG22tkvaFs1GoUr0F_jgV6vPSwy8462fkZ5Oq2WtLT1PwtPqdlg&s=10'
        };
        
        const createDocId = (className, subjectName, chapterName) => {
            const clean = (str) => str.toString().replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            return `${clean(className)}_${clean(subjectName)}_${clean(chapterName)}`;
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const body = document.body, chapterHeaderEl = document.getElementById('chapter-header'), chapterTitleEl = document.getElementById('chapter-title'),
                classDetailsEl = document.getElementById('class-details'), loaderEl = document.getElementById('loader'), videoListEl = document.getElementById('video-list'),
                pdfListEl = document.getElementById('pdf-list'), videosSection = document.getElementById('videos-section'), notesSection = document.getElementById('notes-section'),
                learnBtn = document.getElementById('learn-btn'), notesBtn = document.getElementById('notes-btn');

            const params = new URLSearchParams(window.location.search);
            const className = params.get('class'), subjectKey = params.get('subject'), chapterName = params.get('chapter');

            if (!className || !subjectKey || !chapterName) {
                loaderEl.innerHTML = `<div class="error-message">Error: Missing required URL parameters.</div>`; return;
            }

            const themeClass = themeMap[subjectKey.toUpperCase()];
            if (themeClass) body.classList.add(themeClass);
            const displaySubjectName = fullNameMap[subjectKey.toUpperCase()] || subjectKey;
            chapterTitleEl.textContent = chapterName;
            classDetailsEl.textContent = `Class ${className.replace(/%20/g, ' ')} • ${displaySubjectName}`;

            try {
                const docId = createDocId(className, subjectKey, chapterName);
                const imagePromise = db.collection('chapter_metadata').doc(docId).get();
                const contentPromise = db.collection('content').where('class', '==', className).where('subject', '==', subjectKey).where('chapter', '==', chapterName).get();

                const [imageDocSnap, contentSnapshot] = await Promise.all([imagePromise, contentPromise]);

                let finalImageUrl = imageUrlMap[subjectKey.toUpperCase()] || ''; 
                // --- THIS IS THE CORRECTED LINE ---
                if (imageDocSnap.exists && imageDocSnap.data().headerImageUrl) {
                    finalImageUrl = imageDocSnap.data().headerImageUrl;
                }

                if (finalImageUrl) {
                    chapterHeaderEl.style.backgroundImage = `url('${finalImageUrl}')`;
                }
                
                const videos = [], pdfs = [];
                contentSnapshot.forEach(doc => { const data = doc.data(); if (data.contentType === 'video') videos.push(data); else if (data.contentType === 'pdf') pdfs.push(data); });
                loaderEl.style.display = 'none';
                
                if (videos.length > 0) {
                    videoListEl.innerHTML = videos.map(item => {
                        const playerUrl = `https://xperts-app.github.io/rd/p/?video=${encodeURIComponent(item.url)}`;
                        const videoData = { title: item.title, url: item.url, chapter: chapterName, class: className, subject: subjectKey, progress: Math.floor(Math.random() * 90) + 10 };
                        const escapedVideoData = JSON.stringify(videoData).replace(/'/g, "\\'");
                        return `
                        <li>
                            <a href="${playerUrl}" class="content-item" onclick='saveToContinueWatching(${escapedVideoData})'>
                                <div class="item-thumbnail">${finalImageUrl ? `<img src="${finalImageUrl}" alt="Video thumbnail" class="thumbnail-img">` : `<span class="thumbnail-icon">►</span>`}</div>
                                <div class="item-details"><p class="item-title">${item.title}</p></div>
                                <div class="item-action"><span class="download-icon">↓</span></div>
                            </a>
                        </li>`;
                    }).join('');
                } else { videosSection.innerHTML += '<p>No videos found for this chapter.</p>'; }

                if (pdfs.length > 0) {
                    pdfListEl.innerHTML = pdfs.map(item => `
                        <li>
                            <a href="${item.url}" target="_blank" class="content-item">
                                <div class="item-thumbnail" style="background-color: var(--text-secondary);"><span class="thumbnail-icon"></span></div>
                                <div class="item-details"><p class="item-title">${item.title}</p></div>
                                <div class="item-action"><span class="download-icon">↓</span></div>
                            </a>
                        </li>`).join('');
                } else { notesSection.innerHTML += '<p>No notes found for this chapter.</p>'; }
                
                videosSection.classList.add('active');
            } catch (error) {
                loaderEl.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                console.error("Error fetching content: ", error);
            }
            
            learnBtn.addEventListener('click', () => { learnBtn.classList.add('active'); notesBtn.classList.remove('active'); videosSection.classList.add('active'); notesSection.classList.remove('active'); });
            notesBtn.addEventListener('click', () => { notesBtn.classList.add('active'); learnBtn.classList.remove('active'); notesSection.classList.add('active'); videosSection.classList.remove('active'); });
        });

        function saveToContinueWatching(videoData) {
            let continueWatchingList = JSON.parse(localStorage.getItem('continueWatchingList')) || [];
            continueWatchingList = continueWatchingList.filter(item => item.url !== videoData.url);
            continueWatchingList.unshift(videoData);
            if (continueWatchingList.length > 15) { continueWatchingList = continueWatchingList.slice(0, 15); }
            localStorage.setItem('continueWatchingList', JSON.stringify(continueWatchingList));
        }
    </script>
</body>
</html>
